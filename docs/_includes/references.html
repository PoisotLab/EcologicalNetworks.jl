<script type="text/javascript">

Array.prototype.uav = function()
{
  var n = {},r=[];
  for(var i = 0; i < this.length; i++)
  {
    if (!n[this[i]])
    {
      n[this[i]] = true;
      r.push(this[i]);
    }
  }
  return r;
}

var regexp = /(\[?)(@)(\w+\d{2}\w?)(\]?)/g;

var refs;
jQuery.ajaxSetup({async:false});
gref = function(d) {refs = d; return refs;}
$.getJSON("/references.json", gref);
jQuery.ajaxSetup({async:true});

match = regexp.exec($('.maincontent').text());
while (match != null) {
  var matchedref = match[3];
  var brackets = match[1] == "[";
  var ref = refs.filter(function(a){return a['id'] == matchedref})[0];

  var inline = "";
  inline += ref['author'][0]['family'];
  if (ref['author'].length == 2) {
    inline += " & ";
    inline += ref['author'][1]['family'];
  }
  if (ref['author'].length > 2) {
    inline += " et al.";
  }

  var GOTO = '';
  if (ref['DOI']) {
    var GOTO = "http://dx.doi.org/"+ref['DOI'];
  } else {
    if (ref['URL']) {
      var GOTO = ref['URL'];
    } else {
      var GOTO = "#";
    }
  }

  var pubyear = ref['issued']['date-parts'][0][0];

  var citation = inline;
  if (brackets) {
    citation = "(" + inline + " " + pubyear + ")";
  } else {
    citation = inline + " (" + pubyear + ")";
  }

  reflink = "<a href='" + GOTO + "' title='" + ref['title'] + "' target='_blank' >Go to the paper</a>";
  btn = '<a tabindex="0" class="biblio-ref" role="button" data-toggle="popover" data-trigger="focus" title="' + inline + ' (' + pubyear + ')" data-content="' + ref['title'] + '<hr />' + reflink + '"><i class="far fa-file-alt"></i></a>';
  btn = '<span data-tooltip tabindex="1" title="' + reflink + '" data-allow-html="true">'+citation+'</span>';

  var new_html = $('.maincontent').html().replace(match[0], btn);
  $('.maincontent').html(function() {return new_html});

  match = regexp.exec($('.maincontent').text());
}

</script>
